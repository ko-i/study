# 第3章 内存管理

### 习题

---
#### 1. IBM360有一个设计，为了对2KB大小的块进行加锁，会对每个块分配一个4bit的密钥，这个密钥存在PSW中，每次内存引用时，CPU都会进行密钥的比较。但该设计有诸多缺陷，除了描述中所言，请另外提出至少两点缺陷。
1. 密钥有四位，所以最多只能有16个进程。
2. 每次都要比较，降低效率。
3. 还要占据程序状态字中的4位，就很难受。

---
#### 2. 在图3-3中基址寄存器和限界寄存器含有相同的值16384，这是巧合还是他们总是相等？如果这只是巧合，为什么在这个例子里他们是相等的？
* 巧合，16384代表14位，可能这台机器的实现有关。限界寄存器的值是相对于基址寄存器的偏移量来定的。

---
#### 3. 交换系统通过“紧缩”来消除空闲区。假设有很多空闲区和数据段随机分布，并且读或写32位字长的字需要4ns的时间，“紧缩”4GB的空间大概需要多长时间？为了简单起见，假设字节0在空闲区中，内存中最高地址处含有有效数据。
* 4s

---
#### 4. 在一个交换系统中，按内存地址排列的空闲区大小是10MB、4MB、20MB、18MB、7MB、12MB和15MB。对于连续的段请求：（a）12MB（b）10MB（c）9MB，使用首次适配算法，将找出哪个空闲区？使用最佳适配、最差适配、下次适配算法呢？
* 首次适配算法：3 1 4
* 最佳适配：6 1 7
* 最差适配：3 4 7
* 下次适配：3 4 6

---
#### 5. 物理地址和虚拟地址有什么区别？
* 物理地址就是真实的内存上的地址。虚拟地址是通过操作系统模拟出来展示给进程的地址，通过对物理地址与磁盘上的空间地址映射而成，可以比真是的物理地址大。

---
#### 6. 对下面的每个十进制虚拟地址，分别使用4KB页面和8KB页面计算虚拟页号和偏移量。
* 20000：二进制：0100 1110 0010 0000  4KB：0100 111000100000  8KB：010 0111000100000 
* 32768：二进制：1000 0000 0000 0000  4KB：1000 000000000000  8KB：100 0000000000000
* 60000：二进制：1110 1010 0110 0000  4KB：1110 101001100000  8KB：111 0101001100000

---
#### 7. 使用图3-9的页表，给出下面每个虚拟地址对应的物理地址：
* 20：8212
* 4100：4100
* 8300：8300 + 16K

---
#### 8. Intel8086处理器没有MMU，也不支持虚拟内存，然而一些公司曾经出售过这种系统：包含未做任何改动的8086CPU，支持分页。猜想一下，他们是如何做到这一点的。（提示：考虑MMU的逻辑位置）。
* 他们把MMU放在了内存中。或者说放在了内存和CPU之间的位置。

---
#### 9. 为了让分页虚拟内存工作，需要怎样的硬件支持？
* 需要一个MMU能够将虚拟地址映射到物理地址，并且当在物理地址也找不到时，需要操作系统内核的IO支持。

---
#### 10. 写时复制是使用在服务器系统上的好方法，他能否在手机上起作用？
* 如果手机上支持fork()调用就可以。

---
#### 11. 考虑下面的C程序：...（a）如果这个程序运行在一个页面大小为4KB且有64个TLB表项的机器上，那么M和N取什么值会使得内存够循环的每次执行都会引起TLB失效？（b）如果循环重复很多遍，结果会和a的答案相同吗，请解释。
* 一个int占4B，所以M取大于4KB/4B就是1024时， 然后N要大于64时，每次循环都会失效。
* 如果循环重复很多遍，那也是一样的。

---
#### 12. 可用于存储页面的有效磁盘空间的大小和下列因素有关：最大进程数n，虚拟地址空间的字节数v，RAM的字节数r。给出最坏情况下磁盘空间需求的表达式。这个数量的真实性如何？
* N = n * v - r
* 不是很真实，因为正常情况下远远达不到。最大进程数和最大虚拟内存需求。

---
#### 13. 如果一条指令进行1ns，缺页中断执行额外的Nns，且没k条指令产生一个缺页，请给出一个公式，计算有效指令的时间。
* k * 1
* k / (k + N)

---
#### 14. 一个机器有32位地址空间和8KB页面，页表全在硬件中，页表的每一表项为一个32位字。进程启动时，以每个字100ns的速度将页表从内存复制到硬件中。如果每个进*程运行100ms（包含装入页表的时间），用来装入页表的CPU时间的比例是多少？
* (2 ^ (32 - 13) * 100 * 10 ^ (-9)) / (100 * 10 ^ (-3))

---
#### 15. 假设一个机器有48位的虚拟地址和32位的物理地址。（a）假设页面大小是4KB，如果只有一级页表，那么在页表里有多少页表项？请解释。（b）假设同一系统有TLB，该TLB有32个表项，并且假设一个程序的指令正好能放入一个页，其功能是顺序的从数组中读取长整形元素，该数组存在上千个不同的页中。在这种情况下TLB的效果如何？
* 2^36个页表项 4KB占据12个位，还剩36个位放页表项。
* 每个页面存1024个数，它存在上千个不同的页中，这TLB也只有32个页表项，那命中概率很低啊。

---
#### 16. 给定一个虚拟内存系统的如下数据：（a）TLB有1024项，可以在1个时钟周期（1ns）内访问。（2）页表项可以再100个时钟周期内访问。（c）平均页面替换时间为6ms。如果TLB处理页面访问占99%，并且0.01%的页面访问会发生缺页中断，那么有效地址转换时间是多少？
* 0.99 * 1 + 0.01 * 0.99 * 100 + 0.01 * 0.01 * 6 * 10 ^ 6

---
#### 17. 假设一个机器有38位的虚拟地址和32位的物理地址。（a）与一级页表比较，多级页表的主要优点是什么？（b）若采用2级页表，页面大小为16KB每个页表项为4字节，应该对第一级页表域分配多少位？对二级页表域分配多少位？请说明原因。
* 多级页表减少了查找时间，增大了灵活性。不然每次查找都遍历所有页表项也太不明智了。
* 16KB的的2级页面大小，那就有16KB / 4B = 4K个页表项，2级页表需要12位，页面大小16KB，偏移量就是14位，所还剩6位给一级页表。

---
#### 18. 在3.3.4节的陈述中，奔腾Pro将多级页表中的每个页表项扩展到64位，但仍只能对4GB的内存进行寻址。请解释页表项为64位时，为何这个陈述正确？
* 虚拟地址设计的还是只有32位吧。

---
#### 19. 一个32位地址的计算机使用两级页表。虚拟地址被分成9位的1级页表域、11位的2级页表域和一个偏移量，页面大小是多少？在地址空间中一共有多少个页面？
* 页面大小是2 ^ (32 - 11 - 9) = 2 ^ 12 = 4KB
* 2 ^ 20 个页面

---
#### 20. 一个计算机使用32位的虚拟地址，4KB大小的页面。程序和数据都位于最低的页面（0-4095），栈位于最高的页面。如果使用传统（一级）分页，页表中需要多少个表项？如果使用两级分页，每部分有10位，需要多少个页表项？
* 2 ^ 20个页表项
* 3 * 2 ^ 10个

---
#### 21. 如下是在页大小为512字节的计算机上，一个程序片段的执行轨迹。这个程序在1020地址，其栈指针在8192（栈向0生长）。请给出该程序产生的页面访问串。每个指令（包括立即常数）占4个字节（1个字长）。指令和数据的访问都要在访问串中计数。
* 这个太多了也

---
#### 22. 一台计算机的进程在其地址空间有1024个页面，页表保存在内存中。从页表中读取一个字的开销是5ns。为了减小开销，该计算机使用TLB，他有32个（虚拟页面，物理页框）对，能在1ns中完成查找。请问吧平均开销降到2ns需要命中率是多少？
* 0.8

---
#### 23. TLB需要的相连内存设备如何用硬件实现？这种设计对扩展性意味着什么？
* 这种相连内存设备可以多个同时与查询的key作比较，而且每个位上都要有比较器。意味着设计变得昂贵。

---
#### 24. 一台机器有48位虚拟地址和32位物理地址，页面大小是8KB，如果用一级线性页表，页表项有多少？
* 2 ^ 35个

---
#### 25. 一个计算机的页面大小为8KB，主存大小为256KB，64GB虚拟地址空间使用倒排页表实现虚拟内存。为了保证平均散列链长度小于1，散列表应该多大？假设散列表的大小为2的幂。
* 要2^6 = 64

---
#### 26. 一个学生在编译器设计课程中向教授提议了一个项目，编写一个编译器，用来产生页面访问列表，该列表可以用于实现最优页面置换算法，试问这是否可能？为什么？有什么方法可以改进运行时的页面置换效率？
* 不能，因为没办法填这个表。

---
#### 27. 假设虚拟页码...（a）在工作负载比该序列短的情况下，标准的页面置换算法（LRU，FIFO，Clock）在处理换页时为什么效果不好？（b）如果一个程序分配了500个页框，请描述一个效果优于LRU，FIFO或Clock的页面置换算法。
* 这种序列对于LRU来说无法识别谁是最频繁使用的，只能按照离得最远的先走，和FIFO效果一样，跟Clock作用结果也是一样的。
* 可以固定上499个页框不动，剩下一个轮换。

---
#### 28. 如果将FIFO页面置换算法用到4个页框和8个页面上，若初始页框为空，访问序列串为0172327103，请问会发生多少次缺页中断，如果使用LRU算法呢？
* FIFO会产生4 + 2 = 6次缺页中断。
* LRU会产生4 + 3 = 7次缺页中断。

---
#### 29. 考虑图3-15b中的页面序列。假设从页面B到页面A的R位分别是11011011。使用第二次机会算法，被迁移走的是哪几个页面？
* D

---
#### 30. 一台小计算机有4个页框。在第一个时钟周期时R位是0111（页面0是0，其它页面是1）、在随后的时钟周期中这个值是1011、1010、1101、0010、1010、1100、0001。如果使用带有8位计数器的老化算法，给出最后一个时钟周期后4个计数器的值。
* 01101110
* 01001001
* 00110111
* 10001011

---
#### 31. 请给出一个页面访问序列，使得对于这个访问序列，使用Clock算法和LRU算法得到的第一个被置换的页面不同。假设一个进程分配了3个页框，访问串中的页号属于集合0，1，2，3.
* 0012

---
#### 32. 在图3-20c的工作集时钟算法中，表针指向那个R=0的页面，如果t=400，这个页面将被移出吗？如果t=1000呢？
* 会
* 不会

---
#### 33. 假如工作集时钟页面置换算法使用的t为两个时钟周期，系统状态如下：...

---
#### 34. 一个学生称：“抽象来看，除了选取替代页面使用的属性不同外，基本页面置换算法都相同。”（a）FIFO，LRU、最优算法使用的属性是什么？（b）请给出这些页面置换算法的通用算法。
* FIFO用的是进入的时间，LRU看的是最近使用的时间，最优算法是将来最远的使用时间。
* 找到一个属性排序，然后挑一个最值置换。

---
#### 35. 从平均寻道时间10ms，旋转延迟时间10ms、每磁道32KB的磁盘上载入一个64KB的程序，对于下列页面大小分别需要多少时间？（a）页面大小为2K（b）页面大小为4KB
* 640ms
* 320ms

---
#### 36. 一个计算机有4个页框，载入时间、最近一次访问时间和每个页的R位和M位如下所示（时间以一个时钟周期为单位）：（a）NRU算法将置换哪个页面？（b）FIFO将置换哪个页面？（c）LRU将置换哪个页面？（d）第二次机会算法将置换哪个页面？
* NRU：2
* FIFO：3
* LRU：2
* 第二次机会算法：2

---
#### 37. 假设有两个进程A和B，共享一个不再内存的页。如果进程A在共享叶发生缺页，当该页读入内存时，A的页表项必须更新。（a）在什么条件下，即使进程A的缺页中断处理会将共享页装入内存，B的页表更新也会延迟？（b）延迟页表更新有什么潜在开销？
* B还未因为共享的页发生缺页中断。
* 延迟更新就有可能发现共享页的位置变了，增加了计算开销。

---
#### 38. 有二维数组...
* 第二个会产生最少的缺页中断，第一个在按列查找，每一次内层循环都有可能产生缺页，第二个则只在外层循环时会产生缺页中断。

---
#### 39. 加入你呗宜家云计算公司雇佣，该公司在他的每个数据中心都部署了成千上万的服务器。公司最近听说了一个好方法：在服务器A上处理缺页中断时，是通过读取其它服务器的RAM中的页面，以替代从本地磁盘上读取页面。（a）这种方法如何实现？（b）在什么条件下该方法是有价值的、有效的？
* 在自己机器上发生缺页中断时，缺页中断处理程序会通过网络寻找拥有此页的机器，然后让有用此页的机器解除映射并将此页发送过来，自己再建立此页的映射。
* 网速要大于磁盘IO的速度。

---
#### 40. DEC PDP-1是最早的分时计算机之一，有4K个18位字的内存。在每个时刻它在内存中保持一个进程。当调度程序决定运行另一个进程时，将内存中的进程写到一个换页磁鼓上，磁鼓的表面有4K个18位字。磁鼓可以从任何字开始读写，而不是仅仅在0.请解释为什么要选用这样的磁鼓？
* 因为没有磁盘。

---
#### 41. 一台计算机为每个进程提供65536个字节的地址空间，这个地址空间被划分为多个4KB的页面。一个特定的程序有32768字节的正文、16386字节的数据和15870字节的堆栈。这个程序能装入这个机器的地址空间吗？如果页面大小是512字节，能放得下吗？记住，一个页面不能同时包含两个或者多个不同种类的段。
* 一共16个页面。程序要8个，数据要5个，堆栈要4个，所以不够。
* 这个可以。

---
#### 42. 人们已经观察到在两次缺页中断之间执行的指令数与分配给程序的页框数直接成比例。如果可用内存加倍，缺页中断的平均间隔也加倍。假设一条普通指令需要1us，但是如果发生了缺页中断就需要2001us（即2ms处理缺页中断）结社一个程序运行了60s，期间发生了15000次缺页中断，如果可用内存是原来的两倍，那么这个程序运行需要多少时间？
* 45s

---
#### 43. Frugal计算机公司有一组操作系统设计人员，他们正在考虑一种方法，以在新的操作系统中减少对后备存储数量的需求。老板建议根本不要把程序正文保存在交换区中，而是在需要的时候直接从二进制文件中调页进来。在什么条件下（如果有这样的条件的话），这种想法适用于程序文本？在什么条件下，这种想法适用于数据？
* 当程序文本不会被修改的时候。
* 当数据不会被修改的时候。

---
#### 44. 有一条机器语言指令将要被调入，该指令可把一个32位字装入含有32位字地址的寄存器。这个指令可能引起最大的缺页中断次数是多少？
* 如果都能跨越页面边界，那么这个指令可能导致两次缺页中断，这个字也可能导致两次缺页中断。一共四次。如果不存在跨越页面边界的情况，那么就是2次。

---
#### 45. 解释内部分段和外部分段的区别。分页系统用的是哪一种？纯分段的系统用的又是哪一种？
* 内部分段就是一个进程有一个大段，里面分成了若干段。
* 外部分段就是在内存内有各个类别的段，比如所有进程的程序段都放在一个段里，所有的堆栈段都放在一个段里。
* 分页系统用的是内部分段，纯分段系统用的是外部分段。

---
#### 46. 在MULTICS中，当同时使用分段和分页时，首先必须查找段描述符，然后是页描述符。TLB也是这样按两级查找的方式工作吗？
* TLB不是，TLB是一级查找。

---
#### 47. 一个程序中有两个段，段0中为指令，段1中为读/写数据。段0中有读/执行保护，段1中有读/写保护。内存是按需分页式虚拟内存系统，他的虚拟地址为4位页号，10位偏移量。页表和保护如下所示...
* 地址为11000000000011 无错误
* 保护错误不允许存储
* 缺页中断
* 无法跳转，保护错误

---
#### 48. 你能想象在哪些情况下支持虚拟内存是个坏想法吗？不支持虚拟内存能得到什么好处呢？请解释。
* 在我足够有钱买大内存的时候。

---
#### 49. 虚拟内存提供了远程隔离机制。如果允许两个操作系统同时运行，在内存管理上会有什么麻烦？如何解决这些困哪？
* 这两位操作系统不光抢内存还抢cpu抢io呢。那必须要将每个操作系统可以控制的内存分开来。接两个内存条？同时运行俩操作系统，现在没这么穷了，不要有这种想法。