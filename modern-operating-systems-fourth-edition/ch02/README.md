# 第2章 进程与线程

### 习题

---
#### 1. 图2-2中给出了三个进程状态。理论上，三个状态之间可以有六种切换，每个状态两个。但图中只给出了四种状态切换。其余两种状态是否有可能发生？
* 阻塞->运行 这种感觉是可以发生的，当cpu空闲时，阻塞可以立刻转为运行状态。可以在自己的系统中定制这种行为。
* 就绪->阻塞 这种感觉上不会，就绪状态下不会有什么操作来导致阻塞。唯一的异常应该是可能被外部终止。

---
#### 2. 假设要设计一种先进的计算机体系结构，它使用硬件代替中断来完成进程切换。进程切换时CPU需要哪些信息？请描述用硬件完成进程切换的过程。
* 一个包含当前进程表项的指针，CPU将目前的状态信息保存在这个进程表项中。然后转到中断设备的中断向量，读取另一个进程的表项指针，读取相关内容，启动这个进程。

---
#### 3. 当代计算机中，为什么中断处理程序至少有一部分是有汇编语言编写的。
* 因为中断处理需要直接对硬件（比如读取特定的CPU寄存器）进行操作，高级语言不允许直接操作硬件（或者说不能特别细致的操作硬件）。并且中断要尽可能少的影响当前的进程与线程，所以对其速度也有要求。直接用汇编语言编写，可以跳过编译的冗余过程。

---
#### 4. 中断或系统调用把控制权交给操作系统时，为什么通常会用到与被中断进程的栈分离的内核栈？
* 将中断或系统调用信息保存在内核栈中，可以防止相关信息的泄露。内核拥有自己的栈，也可以防止用户栈溢出导致的程序崩溃引起整个系统的崩溃。

---
#### 5. 一个计算系统的内存有足够的空间容纳5个程序。这些程序有一半的时间处于等待I/O的空闲状态，请问CPU时间浪费的比例是多少？
* (1 / 2) ^ 5 = 0.01325

---
#### 6. 一个计算机的RAM有4GB，其中操作系统占512MB。所有的进程都占256MB并且特征相同。要使CPU利用率达到99%，最大I/O等待是多少？
* (x) ^ 14 <= 0.01  x <= 71.9%

---
#### 7. 如果多个作业能够并行运行，会比他们顺序执行完成的快。假设有两个作业同时开始执行，每个需要20分钟的CPU时间。如果顺序执行，那么完成最后一个作业需要多长时间？如果并行执行有需要多长时间？假设I/O等待为50%。
* 顺序：80分钟
* 并行：60分钟

---
#### 8. 考虑一个6级多道程序系统（内存中可同时容纳6个程序）。假设每个进程的I/O等待占40%，那么CPU利用率是多少？
* 1 - (2 / 5) ^ 6 = 0.996

---
#### 9. 假设要从互联网上下载一个2GB大小的文件，文件内容可以从一组镜像服务器获得，每个服务器可以传输文件的一部分。假设每个传输请求给定起始字节和结束字节。如何用多线程优化下载时间？
* 服务端运行一个调度线程和多个传输线程，调度线程得到请求后查看当前空闲的传输线程，再将传输请求发送给他，因为每个传输请求都请求一部分，所以可以分配给多个传输线程同时传输。
* 同样对于客户端程序会运行多个传输请求线程。
* 最大限制是带宽，建议直接提升带宽。对服务端和客户端都是。

---
#### 10. 为什么图2-11a的模型不适用于在内存中使用高速缓存的文件服务器？每个进程可以有自己的高速缓存吗？
* 如果只有读取操作，应该是可以的，但如果出现写操作，会出现读写不匹配的问题，还是不要这样。
* 如果每个进程都有自己的高速缓存，那不仅会造成资源浪费，高速缓存很贵，而且各个缓存数据之间的同步也会成为一个很大的问题。

---
#### 11. 当一个多线程进程创建子进程时，如果子进程赋值父进程的所有线程，就会出现问题：加入父进程中有一个线程正在等待键盘输入，现在就有两个线程正在等待键盘输入，父进程和子进程各有一个。这种问题在单线程进程中也会发生吗？
* 不会，单线程进程在等待I/O时会阻塞，不能创建子进程。但多线程因为还可以有其它线程可以活动，另一个线程可能会创建子进程。

---
#### 12. 图2-8给出了一个多线程Web服务器。如果读取文件只能使用阻塞的read系统调用，那么Web服务器应该使用用户级线程还是内核级线程？为什么？
* 如果使用用户级，那整个进程内的所有线程都会被阻塞。使用内核级线程还可以通过内核来调用其它线程来运行。

---
#### 13. 在本章中，我们介绍了多线程Web服务器，说明它比单线程服务器和有限状态机服务器更好的原因。存在单线程服务器更好的情形吗？请举例。
* 可以有效的利用CPU资源，因为在某个工作线程因为I/O阻塞时，还可以使用其他工作线程来进行服务。
* 如果用户很少的情况下，不用多线程服务器应该能省一些钱。

---
#### 14. 既然计算机中只有一套寄存器，为什么图2-12中的寄存器集合是按每个线程列出而不是按每个进程列出？
* 这每个线程也有自己的私人信息呀。程序计数器，寄存机，堆栈，状态。那如果没有区分，还要什么多线程。其实多线程和多进程差别也不是很大。

---
#### 15. 在没有时钟中断的系统中，一个线程放弃CPU后可能再也不会获得CPU资源，那么为什么线程还要通过调用thread_yield资源放弃CPU？
* 线程和线程之间是合作关系，又不是进程和进程之间的竞争关系。如果暂时放弃可以获得更好的整体效率，那不放弃还要什么多线程，又不是不还了。都是一个程序员写的。

---
#### 16. 线程可以被时钟中断抢占吗？如果可以，在什么情况下可以？如果不可以，为什么不可以？
* 时钟中断可以通过中断进程的方式来中断在其中运行的线程，用户级中内核无法直接中断线程。但如果是内核级线程，那就可以了。

---
#### 17. 请对使用单线程文件服务器和多线程文件服务器读取文件进行比较。假设所需要的数据都在块高速缓存中，获得工作请求、分派工作并完成其他必要工作需要花费12ms。如果在时间过去1/3时，需要一个磁盘操作，额外花费75ms，此刻该线程进入睡眠。单线程服务器每秒中可以处理多少个请求？多线程服务器呢？
* 1 / (2 / 3 * 12 + 1 / 3 * 87)
* 1 / 12

---
#### 18. 在用户态实现线程的最大优点是什么？最大缺点是什么？
* 最大优点是线程之间切换开销很小。
* 最大缺点是如果一个线程阻塞整个进程都阻塞。

---
#### 19. 图2-15中，创建线程和线程打印消息的顺序是随机交错的。有没有一种方法可以严格按照一下次序进行：创建线程1，线程1打印消息，线程1结束，创建线程2，线程2打印消息，线程2结束，依此类推。如果有，请说明方法；如果没有，请解释原因。
* 在pthread_create()后调用pthread_join()等这个线程结束了在创建下一个线程。

---
#### 20. 在讨论线程中的全局变量时，曾经使用过程create_globe将存储分配给指向变量的指针，而不是变量自身。这是必须的嘛？还是直接使用变量本身也行？
* 不是必须的，但最好这么做，因为全局变量大小本身不知道，想要真正实现还得传大小，所以传指针会比较简单。

---
#### 21. 考虑一个线程全部在用户态实现的系统，该运行时系统每秒钟获得一个时钟中断。当某个线程正在该运行时系统中执行时发生了一个时钟中断，此时会出现什么问题？你有什么解决该问题的建议吗？
* 运行时系统会在这个时候立刻阻塞该线程或者解除阻塞其它线程，这时候运行时系统内的线程表会发生变化，时钟中断程序必须要等到运行时系统的调度行为结束后才能再运行。通过设置运行时系统行为结束的标志。或者等待运行时系统的各种行为结束后再通知中断程序。

---
#### 22. 假设一个操作系统中不存在类似于select的系统调用来提前判断从文件、管道或设备中读取数据时是否安全，但该操作系统允许设置定时来中断阻塞的系统调用。在上述条件下，是否有可能在用户态实现一个线程包？请讨论。
* 可以，线程在运行系统调用前设置一个定时器，如果定时器中断前还在阻塞，那就中断阻塞。就是效率会降低，因为可能大部分系统调用都是不会引起阻塞的。

---
#### 23. 两个进程在一个共享内存的多处理器（两个）上运行，当他们要共享一块内存时，图2-13中使用turn变量的忙等待方法还有效吗？
* 有效。

---
#### 24. 在抢占式进程调度的条件下，图2.24中互斥问题Peterson解法可行吗？如果是非抢占式调度呢？
* 在抢占式的条件下可以。但非抢占式的话，会出现某一方一直运行的可能，比如turn初始化为0，但是1先进入，这时候最后面while循环的值一直为真。

---
#### 25. 2.3.4节中所讨论的优先级反转问题在用户级线程中是否可能发生？为什么？
* 不会，因为在用户级线程中没有优先级的说法，不会出现低优先级等待高优先级运行的问题。

---
#### 26. 2.3.4节中描述了一种有高优先级进程H和低优先级进程L的情况，导致H陷入了死循环。若采用轮转调度算法代替优先级调度算法，还会发生同样的问题吗？请讨论。
* 不会发生了。因为L有机会离开临界区。如果出现不能离开的情况，那跟调度算法也没有关系。

---
#### 27. 在使用线程的系统中，若使用用户级线程，是每个线程一个栈还是每个进程一个栈？如果使用内核级线程呢？请解释。
* 不管是用户级还是内核级，每个线程都有自己的栈。

---
#### 28. 在开发计算机时，通常首先用一个程序模拟执行，一次运行一条指令，多处理器也严格按照此模拟。在这种没有同时事件发生的情况下，会出现竞争条件吗？
* 有可能，只要某个进程在一项设计公共存储区的操作未执行完发生时钟中断被切换到另一个进程执行，就有可能发生竞争条件。

---
#### 29. 将生产者-消费者问题扩展成一个多生产者-多消费者的问题，生产者和消费者都读和写一个共享的存储区，每个生产者和消费者都在自己的线程中执行。图2-28中使用信号量的解法在这个系统中还可行吗？
* 可行。不管有几个，反正只允许一个进行读写操作。

---
#### 30. 考虑对于两个进程P0和P1的互斥问题的解决方案，假设变量初始值为0。P0的代码如下：P1的代码是将上述代码中的0替换成1.该方法是否能处理互斥问题中所有可能的情形？
* 这个跟24题的类似，可以解决互斥问题，但要控制初始化变量的值与先进入临界区的线程。不然有可能出现无限的忙等待。

---
#### 31. 一个可以屏蔽中断的操作系统如何实现信号量？
* 在执行一个up或down操作时，屏蔽中断，实现原子性操作。

---
#### 32. 请说明仅通过二元信号量和普通机器指令如何实现计数信号量（即可以保持一个任意值的信号量）？
* 可以用一堆二元信号量来表示计数。

---
#### 33. 如果一个系统只有两个进程，可以使用一个屏障来同步这两个进程吗？为什么？
* 互斥操作不可以，只要有这种同步需求都可以。

---
#### 34. 如果线程在内核态实现，可以使用内核信号量对同一个进程中的两个线程进行同步吗？如果线程在用户态呢？假设其他进程没有线程需要访问信号量。请解释你的答案。
* 内核态时当一个线程被信号量阻塞后，内核可以调用这个进程的其它线程执行。可以。
* 在用户态上某一线程被信号量阻塞后，内核会认为整个进程被阻塞，就切换进程执行了，所以不行。

---
#### 35. 管程的同步机制使用条件变量和两个特殊操作wait和signal。一种更通用的同步形式是只用一条原语waituntil，它以任意的布尔谓词作为参数。例如`waituntil x<0 or y+z<n`。这样就不再需要signal原语。很显然这种方法比Hoare或Brinc Hansen方案更通用，但他从未被采用过。为什么？
* 计算谓词的代价太高。

---
#### 36. 一个快餐店有四类雇员：（1）领班，接受顾客点的菜单；（2）厨师，准备饭菜；（3）打包员，将饭菜装在袋子里；（4）收银员，将食品袋交给顾客并收钱。每个雇员可被看做一个可以进行通信的串行进程，那么进程间通信模型是什么？请将这个模型与UNIX中的进程联系起来。
* 可以通过消息来通信。消息分别是菜单，饭菜，袋子。四个进程通过管道连接。

---
#### 37. 假设有一个使用信箱的消息传递系统，当向满信箱发消息或从空信箱取消息时，进程不会阻塞，而是得到一段错误代码。进程响应错误代码的处理方式是不断地重试，知道成功为止，这种方式会导致竞争条件吗？
* 不会，没有其他进程能插得进来，是忙等待。

---
#### 38. CDC 6600计算机使用一种乘坐处理器共享的有趣的轮转调度算法，可以同时处理多达10个I/O进程。每条指令结束后都进行进程切换，即进程1执行指令1，进程2执行指令2，以此类推。进程切换由特殊的硬件完成，所以没有开销。如果在没有竞争的条件下一个进程需要T秒钟完成，那么当有n个进程共享处理器时完成该进程需要多长时间？
* nT

---
#### 39. 考虑以下C代码：...程序执行时创建了多少进程？
* 3个

---
#### 40. Round-robin调度算法一般需要维护一个就绪进程列表，每个进程在列表中只出现一次。如果某个进程在列表中出现两次会发生什么情况？什么情况下可以允许多次出现？
* 多次出现就可以多次分得时间片，对于重要的进程可以这样做。

---
#### 41. 是否可以通过分析源代码来确定进程是CPU密集型的还是I/O密集型的？运行时如何确定？
* 再简单的程序中可以分析出来。运行时可以通过ps命令来查看进程的cpu时间占总时间的比例来分析。

---
#### 42. 请说明在Round-robin调度算法中时间片长度和上下文切换时间是怎样相互影响的？
* 时间片越长，CPU利用率越高。关键取决于上下文切换的时间，一般时间片长度要比上下文切换时间大很多那样才不亏。

---
#### 43. 对某系统进行检测后发现，在阻塞I/O之前，平均每个进程的运行时间为T。一次进程切换需要的时间为S，这里S实际上就是开销。对于采用时间片长度为Q的轮转调度，请给出以下各种情况的CPU利用率的计算公式。
1. T / (T + S)
2. T / (T + S)
3. 1 - (T / Q * S) / (T +  (T / Q * S))
4. 1 / 2
5. 0

---
#### 44. 有5个待运行作业，估计他们的时间分别是9，6，3，5和X。以何种次序运行这写作业能得到最短平均响应时间？
* 0 < X < 3: X, 3, 5, 6, 9
* 3 < X < 5: 3, X, 5, 6, 9
* 5 < X < 6: 3, 5, X, 6, 9
* 6 < X < 9: 3, 5, 6, X, 9
* 9 < X    : 3, 5, 6, 9, X

---
#### 45. ...
* 这个需要看每个时间片的分配有多少。
* 20min
* 19.2min
* 14min

---
#### 46. 运行在CTSS上的某个进程需要30个时间片才能完成。该进程必须被调入多少次（包括第一次，即在该进程运行之前）
* 5个

---
#### 47. 一个实时系统有2个周期为5ms的电话任务，每次任务的CPU处理时间是1ms；还有一个周期为33ms的视频流，每次任务的CPU时间是11ms。这个系统是可调度的吗？
* 是

---
#### 48. 在上一道题中，如果再加入一个视频流，系统还是可调度的吗？
* 不是了。

---
#### 49. 用a = 1/2的老化算法来预测运行时间。先前的四次运行，从最老到最近的一个，其运行时间分别是40ms、20ms、40ms和15ms。那么下一次的预测时间是多少？
* 22.5ms

---
#### 50. 一个软实时系统有4个周期时间，其周期分别为50ms、100ms、200ms和250ms。假设4个事件分别需要35ms、20ms、10ms和xms的CPU时间。保持系统可调度的最大x值是多少？
* 12.5ms

---
#### 51. 在哲学家就餐问题中使用如下规则：编号为偶数的哲学家先拿他左边的叉子再拿他右边的叉子；编号为奇数的哲学家先拿他右边的叉子再拿他左边的叉子。这条规则是否能避免死锁？
* 能避免。

---
#### 52. 一个实时系统需要处理两个语音通信，每个通信都是6ms运行一次，每次占用1ms的CPU时间，加上25帧/每秒的视频，每一帧需要20ms的CPU时间。这个系统是可调度的吗？
* 可以调度。

---
#### 53. 考虑一个系统，希望以策略与机制分离的方式实现内核级线程调度。请提出一种解决方案。
* 让用户设置优先级的机制，内核按照优先级高低的机制来运行。

---
#### 54. 在哲学家就餐问题的解法中，为什么在过程take_forks中将状态设置为HUNGRY？
* 表名这个哲学家当前正在尝试拿取叉子的状态，如果没有成功，就会被阻塞，在它相邻的那个哲学家吃完准备放叉子时会检测这个哲学家的状态，如果出于饥饿，那么则可以通知他拿起这个叉子。

---
#### 55. 考虑图2-47中的过程put_forks，假设变量state[i]在对test的两次调用之后（而不是之前才被设置为THINKING）这会对解法有什么影响？
* 那么如果它旁边的两个哲学家如果想要获得叉子但会检测到当前哲学家还处在EATING状态，会获取失败。然后就再也不会有信号通知他去取叉子了。

---
#### 56. 按照哪一类进程何时开始执行，读者-写者问题可以有几种方式求解。请详细描述该问题的三种变体，每一种变体偏好（或不偏好）某一类进程。对每种变体，请指出当一个读者或写者访问数据库时会发生什么，以及当一个进程结束对数据库访问时又会发生什么？
* 读者优先 当有读者时，读者可以进来，写者等待，当没有读者时，写者进来，写者写完，优先让处于排队状态的读者进来。
* 写者优先 当有写者时，等写者写完，优先让排队中的写者进来。但没有写者时，让读者进，读者读的时候其它读者可以进来。
* 当有读者读时，读者可以进，当没有读者时，写者进，写者结束时如果有读者就读者进，如果没有读者再写者进。
* 当读者正在读的时候如果有写者想进，那么就不允许新的读者进来。（和书中一样） 

---